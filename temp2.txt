

====================================================================
TOPIC 1: HOW TO DETECT WHICH ITEM VALUE IS CHANGED BY ADMIN
====================================================================

1. OVERVIEW
When the admin updates any entity (user, product, seller, order), you need to know:
- what the old value was,
- what the new value is,
- which field changed,
- who changed it,
- when it changed.

2. GENERAL APPROACH
There are two common approaches:

A. COMPARE OLD DATA WITH NEW DATA
----------------------------------
Step 1 → Fetch existing record from DB before updating.  
Step 2 → Compare each field with the new POSTed value.  
Step 3 → If old_value != new_value, record a log in admin_activity table.  
Step 4 → Store:
- table_name  
- record_id  
- field_name  
- old_value  
- new_value  
- admin_id  
- timestamp  

Example comparison logic (pseudo):
old = get_old_record(id)
new = $_POST

foreach fields:
    if old[field] != new[field]:
        insert into admin_activity

B. USE JSON SNAPSHOT
---------------------
Store old data as JSON and new data as JSON.  
Later compare using PHP array_diff_assoc.

This is heavier but flexible.

3. FIELDS TO LOG WHEN CHANGES OCCUR
- admin_id (who changed)
- module_name (user/product/order/seller)
- record_id (which item changed)
- field_name
- old_value
- new_value
- changed_at timestamp

4. BENEFIT
You can fully track what admin changed, including:
- previous price
- updated order status
- changed email/user info
- modified coupon conditions
- seller approval status

====================================================================
TOPIC 2: IF ADMIN REMOVES A COUPON FROM ORDER, ORDER MUST RESTORE ORIGINAL PRICE
====================================================================

1. PURPOSE
If admin removes coupon benefits incorrectly, order may show discounted price forever, which is incorrect.

The correct approach:
- Recalculate total_amount based on original product prices (without coupon)
- Remove coupon_id from order table
- Update discount_amount = 0

2. REQUIRED CHANGES IN ORDER TABLE
Add the following fields:
- subtotal_amount (sum of all order_items total)
- discount_amount (discount applied by coupon)
- final_amount (subtotal - discount + tax + shipping)
- coupon_id (nullable or 0 if no coupon)

3. HOW TO STORE ORIGINAL PRICE
When creating the order:
- store each product's price in order_items table as "price"
This ensures if coupon is removed later, the system can use stored price.

You MUST NOT calculate product price again from products table, because:
- price may have changed later in the product table
- order should show the price at time of purchase

Recalculation formula:
subtotal = SUM(order_items.total_price)
final_amount = subtotal + tax + shipping

4. SERVICE LOGIC FOR REMOVING COUPON
Steps:
1. Fetch order items  
2. Recalculate subtotal  
3. Remove coupon_id from order table  
4. Set discount_amount = 0  
5. Set final_amount = recalculated subtotal + tax  
6. Log admin activity: "Coupon Removed"  

5. REDUCE FUTURE ERRORS
- Always store price at time of purchase  
- Never recalc price from products table  
- Always maintain fields: subtotal, discount_amount, final_amount  

====================================================================
TOPIC 3: MERGED FULL DETAILS OF LAST 3 CHAT TOPICS
====================================================================

1. DETECTING ADMIN CHANGES
- Fetch old data before update  
- Compare old with new  
- Log differences in admin_activity table  

Example fields for admin_activity:
id (PK)
admin_id
table_name
record_id
field_name
old_value
new_value
action_type (update, delete, create)
created_at timestamp

2. RESTORING ORIGINAL PRICE WHEN COUPON REMOVED
- Use subtotal_amount field (sum of item prices)
- Use discount_amount field for coupon discount
- Use final_amount to store actual payable amount
- Removing coupon sets:
  coupon_id = NULL
  discount_amount = 0
  final_amount = subtotal + tax + shipping

3. WHEN TO RECALCULATE ORDER AMOUNT
A. When coupon is applied  
B. When coupon is removed  
C. When product quantities are changed  
D. When tax or shipping changes  

4. REQUIRED ORDER TABLE STRUCTURE
order table fields must include:
subtotal_amount
discount_amount
final_amount
coupon_id (nullable)
tax_amount
shipping_amount

These allow recalculation anytime without needing product table.

5. ADMIN WORKFLOW FOR REMOVING COUPON
- Admin clicks Remove Coupon  
- AJAX request to OrderController  
- Controller recalculates the total without discount  
- Updates DB  
- Logs activity in admin_activity  
- Returns success message  

6. HOW TO PREVENT CHANGING TO PREVIOUS ORDER STATUS
Use numeric statuses:
1 = Pending  
2 = Processing  
3 = Shipped  
4 = Delivered  
5 = Cancelled  

Rule:
new_status must be > old_status (except cancel operation)

Example PHP:
if($new_status < $old_status && $new_status != 5) {
   return error("Cannot move backward");
}

7. STORE ORDER STATUS ACTIVITY
Create order_status_activity table:
id
order_id
status_code (number)
changed_by (admin_id or user_id)
remarks
changed_at timestamp

You store:
status history
refund status if user cancels

8. REFUND STATUS FIELD FOR USER CANCELLATION
If user cancels the order:
- order_status = CANCELLED
- refund_status field should be added

refund_status values:
0 = No Refund Required  
1 = Refund Initiated  
2 = Refund Completed  

This works only for prepaid orders.

9. HOW ADMIN CAN KNOW WHICH FIELD WAS UPDATED
Before updating:
- fetch old record
- compare with new submitted fields
- log changed values as activity row

10. HOW ORDER REFLECTS ORIGINAL PRICE IF ADMIN REMOVES COUPON
After detection:
- Remove coupon relationship
- Recalculate total using stored original item prices
- Update order financial fields (discount, subtotal, final)

====================================================================
END OF TEXT
====================================================================

<?php
/*************************************
 SIMPLE CATEGORY CRUD (Single File)
 Parent + Child Category System
**************************************/

// DB CONNECTION
$host = "localhost";
$user = "root";
$pass = "";
$dbname = "test_db"; // Change this to your DB name

try {
    $pdo = new PDO("mysql:host=$host;dbname=$dbname", $user, $pass);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
} catch (PDOException $e) {
    die("DB Connection Failed: " . $e->getMessage());
}

// CREATE TABLE IF NOT EXISTS
$pdo->exec("
CREATE TABLE IF NOT EXISTS categories (
    id INT AUTO_INCREMENT PRIMARY KEY,
    parent_id INT NULL,
    name VARCHAR(150) NOT NULL,
    slug VARCHAR(200) UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
");

// Function to get all categories
function getCategories($pdo) {
    $stmt = $pdo->query("SELECT * FROM categories ORDER BY parent_id ASC, name ASC");
    return $stmt->fetchAll(PDO::FETCH_ASSOC);
}

// INSERT CATEGORY
if (isset($_POST['add'])) {
    $name = $_POST['name'];
    $parent = !empty($_POST['parent_id']) ? $_POST['parent_id'] : NULL;
    $slug = strtolower(str_replace(" ", "-", $name));
    $stmt = $pdo->prepare("INSERT INTO categories(name, parent_id, slug) VALUES (?, ?, ?)");
    $stmt->execute([$name, $parent, $slug]);
    header("Location: category_crud.php");
}

// DELETE CATEGORY
if (isset($_GET['delete'])) {
    $id = $_GET['delete'];
    $pdo->prepare("DELETE FROM categories WHERE id=?")->execute([$id]);
    header("Location: category_crud.php");
}

// EDIT CATEGORY - Fetch Data
$editData = null;
if (isset($_GET['edit'])) {
    $stmt = $pdo->prepare("SELECT * FROM categories WHERE id=?");
    $stmt->execute([$_GET['edit']]);
    $editData = $stmt->fetch(PDO::FETCH_ASSOC);
}

// UPDATE CATEGORY
if (isset($_POST['update'])) {
    $name = $_POST['name'];
    $parent = !empty($_POST['parent_id']) ? $_POST['parent_id'] : NULL;
    $id = $_POST['id'];
    $slug = strtolower(str_replace(" ", "-", $name));

    $stmt = $pdo->prepare("UPDATE categories SET name=?, parent_id=?, slug=? WHERE id=?");
    $stmt->execute([$name, $parent, $slug, $id]);
    header("Location: category_crud.php");
}

$categories = getCategories($pdo);

// Function to show category dropdown with indentation
function showCategoryOptions($categories, $parent_id = NULL, $level = 0, $selected = null) {
    foreach ($categories as $cat) {
        if ($cat['parent_id'] == $parent_id) {
            $indent = str_repeat("&nbsp;&nbsp;&nbsp;", $level);
            $isSelected = ($selected == $cat['id']) ? "selected" : "";
            echo "<option value='{$cat['id']}' $isSelected>{$indent}" . ($level ? "↳ " : "") . "{$cat['name']}</option>";
            showCategoryOptions($categories, $cat['id'], $level + 1, $selected);
        }
    }
}
?>

<!DOCTYPE html>
<html>
<head>
    <title>Category CRUD (Parent + Child)</title>
    <style>
        body { font-family: Arial; margin: 40px; }
        table { width: 60%; border-collapse: collapse; margin-top: 20px; }
        table, th, td { border: 1px solid #aaa; padding: 8px; }
        th { background: #f0f0f0; }
        form { margin-bottom: 20px; }
        input, select { padding: 5px; margin: 5px 0; width: 200px; }
        button { padding: 5px 10px; }
    </style>
</head>
<body>

<h2>Category Management (Parent + Child)</h2>

<!-- ADD / EDIT FORM -->
<form method="POST">
    <input type="hidden" name="id" value="<?= $editData['id'] ?? '' ?>">
    <label>Category Name:</label><br>
    <input type="text" name="name" required value="<?= $editData['name'] ?? '' ?>"><br>

    <label>Parent Category:</label><br>
    <select name="parent_id">
        <option value="">-- Root / No Parent --</option>
        <?php showCategoryOptions($categories, NULL, 0, $editData['parent_id'] ?? null); ?>
    </select><br>

    <?php if ($editData): ?>
        <button type="submit" name="update">Update</button>
        <a href="category_crud.php">Cancel</a>
    <?php else: ?>
        <button type="submit" name="add">Add Category</button>
    <?php endif; ?>
</form>

<!-- DISPLAY TABLE -->
<table>
    <tr>
        <th>ID</th>
        <th>Category</th>
        <th>Parent</th>
        <th>Actions</th>
    </tr>
    <?php foreach ($categories as $cat): ?>
        <tr>
            <td><?= $cat['id'] ?></td>
            <td>
                <?= $cat['parent_id'] ? "↳ " : "" ?>
                <?= $cat['name'] ?>
            </td>
            <td>
                <?php
                $parent = array_filter($categories, fn($c) => $c['id'] == $cat['parent_id']);
                echo $parent ? array_values($parent)[0]['name'] : '—';
                ?>
            </td>
            <td>
                <a href="?edit=<?= $cat['id'] ?>">Edit</a> |
                <a href="?delete=<?= $cat['id'] ?>" onclick="return confirm('Delete this category?')">Delete</a>
            </td>
        </tr>
    <?php endforeach; ?>
</table>

</body>
</html>
